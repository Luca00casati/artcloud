<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>visualizer</title>
<style>
body, html {
  margin: 0;
  padding: 0;
  background-color: #000;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.inline {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  gap: 10px;
  background-color: #000;
  color: #fff;
  margin: 0;
  padding: 0;
}
</style>
  </head>
  <body>
    <div class="inline">
    <h2>ðŸŽµ Upload a File</h2>
    <button id="playPauseBtn" disabled>Pause</button>
    <input type="file" id="fileInput" accept="audio/*" />
    </div>
    <canvas id="visualizer"></canvas>
<script>
let audioContext;
let analyser;
let sourceNode;
let audioBufferSource;
let currentBuffer;
let dataArray;
let animationId;

let canvas, ctx;
let isPlaying = false;
const scale = 0.8;
const color = '#00ffc8';

const fileInput = document.getElementById('fileInput');
const playPauseBtn = document.getElementById('playPauseBtn');

// Initialize canvas
window.addEventListener('load', () => {
  canvas = document.getElementById('visualizer');
  ctx = canvas.getContext('2d');
  resizeCanvas();

  window.addEventListener('resize', resizeCanvas);
  fileInput.addEventListener('change', handleFileInput);
  playPauseBtn.addEventListener('click', togglePlayPause);

  setupDragAndDrop();
});

function resizeCanvas() {
  canvas.width = window.innerWidth * scale;
  canvas.height = window.innerHeight * scale;
}

// Handle file input (from <input>)
function handleFileInput(e) {
  const file = e.target.files[0];
  if (file && file.type.startsWith('audio/')) {
    loadAudioFile(file);
  }
}

// Load and decode audio file
function loadAudioFile(file) {
  stopAudio();

  const reader = new FileReader();
  reader.onload = async (e) => {
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }

    const arrayBuffer = e.target.result;
    audioContext.decodeAudioData(arrayBuffer, (buffer) => {
      currentBuffer = buffer;
      startAudio();
    }, (err) => {
      console.error('Error decoding audio:', err);
    });
  };

  reader.readAsArrayBuffer(file);
}

// Start playing the audio and visualization
function startAudio() {
  if (!currentBuffer) return;

  audioBufferSource = audioContext.createBufferSource();
  audioBufferSource.buffer = currentBuffer;
  audioBufferSource.loop = true;

  analyser = audioContext.createAnalyser();
  analyser.fftSize = 1024;
  analyser.smoothingTimeConstant = 0.8;
  const bufferLength = analyser.frequencyBinCount;
  dataArray = new Uint8Array(bufferLength);

  audioBufferSource.connect(analyser);
  analyser.connect(audioContext.destination);
  audioBufferSource.start(0);

  isPlaying = true;
  playPauseBtn.disabled = false;
  playPauseBtn.textContent = 'Pause';

  draw();
}

// Stop audio and animation
function stopAudio() {
  if (audioBufferSource) {
    try {
      audioBufferSource.stop();
      audioBufferSource.disconnect();
    } catch (e) {
      console.warn('Audio already stopped.');
    }
    audioBufferSource = null;
  }

  if (animationId) {
    cancelAnimationFrame(animationId);
  }

  isPlaying = false;
  playPauseBtn.textContent = 'Play';
}

// Toggle play/pause
function togglePlayPause() {
  if (!audioContext) return;

  if (audioContext.state !== 'running') {
    audioContext.resume();
  }

  if (isPlaying) {
    stopAudio();
  } else {
    startAudio();
  }
}

// Visualization loop
function draw() {
  animationId = requestAnimationFrame(draw);
  analyser.getByteFrequencyData(dataArray);

  ctx.fillStyle = 'black';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const barWidth = canvas.width / dataArray.length;
  ctx.fillStyle = color;

  for (let i = 0; i < dataArray.length; i++) {
    const barHeight = (dataArray[i] / 255) * canvas.height;
    const x = i * barWidth;
    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
  }
}

// Drag and drop setup
function setupDragAndDrop() {
  window.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
    document.body.style.border = `4px dashed ${color}`;
  });

  window.addEventListener('dragleave', (e) => {
    e.preventDefault();
    document.body.style.border = 'none';
  });

  window.addEventListener('drop', (e) => {
    e.preventDefault();
    document.body.style.border = 'none';

    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('audio/')) {
      loadAudioFile(file);
    } else {
      alert('Please drop a valid audio file.');
    }
  });
}
</script>
  </body>
</html>
